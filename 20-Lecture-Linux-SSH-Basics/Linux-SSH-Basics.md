# Лекція: **SSH (Secure Shell) — безпечний віддалений доступ і передача файлів**

> У цій лекції розбираємо **SSH**: навіщо він потрібен, як проходить автентифікація (пароль vs ключі), що таке порт 22 і правила firewall, як підключитися до віддаленого сервера (на прикладі DigitalOcean), скопіювати файли через **SCP**, та безпечні налаштування виробничого середовища.

---

## Навчальні цілі
Після лекції ви зможете:
- Пояснити, **чому потрібен SSH** і чим він безпечний.
- Підключатися до серверів за паролем і за **SSH‑ключами**.
- Розуміти роль **порту 22** і **firewall** для SSH‑доступу.
- Згенерувати ключі, додати публічний ключ у **authorized_keys** і виконувати вхід **без пароля**.
- Скопіювати файли **scp** і запускати скрипти на віддаленій машині.
- Застосувати практичні поради безпеки (доступ «за білим списком», `PermitRootLogin`, `PasswordAuthentication`, `ssh-agent`).

---

## План лекції
1. Навіщо потрібен SSH
2. Методи автентифікації: пароль і SSH‑ключі
3. SSH‑сервіс, порт 22 і firewall
4. Практика: підключення до Droplet на DigitalOcean
5. Копіювання файлів: `scp` (і варіанти)
6. Виконання скриптів/команд на віддаленому сервері
7. Cloud‑firewall DigitalOcean і видалення сервера
8. Практикум (15–25 хв)
9. Безпека: кращі практики та типові помилки
10. Контрольні питання
11. Аналогія «хатина та приватний тунель»
12. Шпаргалка

---

## 1) Навіщо потрібен SSH

- Адміністрування **віддалених серверів**: встановлення ПЗ, деплой, діагностика.
- Масове копіювання скриптів на **багато вузлів** і їх запуск.
- Робота **тільки через CLI** там, де GUI відсутній (типово для серверів).
- **Безпечний канал** (шифрування + автентифікація) поверх ненадійної мережі/Інтернету.

---

## 2) Методи автентифікації

### а) Користувач і пароль
- Ви входите як існуючий **користувач сервера** (напр., `root` або інший обліковий запис, створений адміністратором).
- Простий старт, але менш безпечний для постійної роботи.

### б) Пара **SSH‑ключів** (рекомендовано)
- Створюється **приватний** і **публічний** ключ.
- **Приватний ключ** зберігається **лише** на вашій локальній машині і може бути захищений **passphrase**.
- **Публічний ключ** додається на сервер у файл `~/.ssh/authorized_keys` потрібного користувача.
- При підключенні сервер перевіряє, чи відповідає приватний ключ публічному.

> Рекомендовано сучасний алгоритм:
```bash
ssh-keygen -t ed25519 -C "your_email@example.com"
# (за потреби для сумісності) ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
```
Ключі типово зберігаються як `~/.ssh/id_ed25519` (або `id_rsa`) і `~/.ssh/id_ed25519.pub` (або `id_rsa.pub`).

**Командні сервіси** (Jenkins, CI): генерують власну пару ключів; публічний ключ CI додається в `authorized_keys` сервера‑призначення.

---

## 3) SSH‑сервіс, порт 22 і firewall

- **SSH‑демон** (`sshd`) за замовчуванням слухає **TCP‑порт 22**.
- Щоб мати доступ ззовні, у **firewall** потрібно **дозволити** вхідний трафік до 22/tcp.
- Краще обмежити доступ **білим списком IP** адміністраторів/Офісу/VPN.

> Приклади для Linux‑хоста:
```bash
# UFW
sudo ufw allow from 203.0.113.10 to any port 22 proto tcp
sudo ufw enable

# firewalld
sudo firewall-cmd --add-rich-rule='rule family=ipv4 source address=203.0.113.10/32 port port=22 protocol=tcp accept' --permanent
sudo firewall-cmd --reload
```

---

## 4) Приклад: підключення до Droplet на DigitalOcean

1) **Створіть** Droplet (напр., регіон Франкфурт, Ubuntu).  
2) **Початковий доступ паролем** (якщо ще без ключів):
```bash
ssh root@<IP_АДРЕСА_СЕРВЕРА>
# при першому вході підтвердіть хост (yes) і введіть пароль
```
Після входу у вас буде prompt із `root@<hostname>` і каталог `/root`.

3) **Згенеруйте ключі** локально (див. вище) і **передайте публічний ключ** на сервер.
Найпростіше — `ssh-copy-id`:
```bash
ssh-copy-id -i ~/.ssh/id_ed25519.pub root@<IP_АДРЕСА_СЕРВЕРА>
```
Або вручну:
```bash
# на сервері
mkdir -p ~/.ssh && chmod 700 ~/.ssh
vim ~/.ssh/authorized_keys     # вставте вміст локального *.pub
chmod 600 ~/.ssh/authorized_keys
```

4) **Повторне підключення без пароля**:
```bash
ssh root@<IP_АДРЕСА_СЕРВЕРА>
# якщо ключ інший або в іншому місці:
ssh -i ~/.ssh/id_ed25519 root@<IP_АДРЕСА_СЕРВЕРА>
```

> Порада: додайте запис у `~/.ssh/config` для зручності:
```bash
Host prod-do
  HostName <IP_АДРЕСА_СЕРВЕРА>
  User root
  IdentityFile ~/.ssh/id_ed25519
```
Тоді достатньо: `ssh prod-do`.

---

## 5) Копіювання файлів: `scp`

Передача **локально → сервер**:
```bash
scp test.sh root@<IP_АДРЕСА_СЕРВЕРА>:/root/
# або з явним ключем:
scp -i ~/.ssh/id_ed25519 test.sh root@<IP_АДРЕСА_СЕРВЕРА>:/root/
```

Сервер → локально:
```bash
scp root@<IP_АДРЕСА_СЕРВЕРА>:/root/test.sh ./
```

Папка рекурсивно:
```bash
scp -r ./app root@<IP_АДРЕСА_СЕРВЕРА>:/opt/app
```

> Альтернатива для великих/частих передач: **`rsync`**
```bash
rsync -avz -e "ssh -i ~/.ssh/id_ed25519" ./app/ root@<IP_АДРЕСА_СЕРВЕРА>:/opt/app/
```

---

## 6) Виконання скриптів/команд на віддаленому сервері

Інтерактивно:
```bash
ssh root@<IP_АДРЕСА_СЕРВЕРА>
ls && chmod u+x test.sh && ./test.sh
```

Одноразова команда **без входу в shell**:
```bash
ssh root@<IP_АДРЕСА_СЕРВЕРА> 'chmod u+x /root/test.sh && /root/test.sh'
```

Передати і **виконати локальний скрипт** на віддаленій машині «на льоту»:
```bash
ssh root@<IP_АДРЕСА_СЕРВЕРА> 'bash -s' < ./setup.sh
```

---

## 7) Cloud‑firewall DigitalOcean і видалення сервера

- За замовчуванням Droplet **не має** прив’язаного cloud‑firewall → трафік регулює лише firewall **на самому сервері** (якщо налаштований).  
- У DigitalOcean можна створити **Firewall** (через UI/API), заблокувати все і відкрити лише потрібні порти (22/tcp для SSH, 80/443 для вебтощо), обмежити джерела.
- Після завершення робіт **знищіть Droplet**, щоб **не сплачувати** за ресурси.

---

## 8) Практикум (15–25 хв)

1) **Перше підключення** до нового Droplet за паролем, потім додайте ключ і перепідключіться **без пароля**.  
2) **Створіть** локально `test.sh`, скопіюйте на сервер `scp` і виконайте.  
3) Налаштуйте `~/.ssh/config` і перевірте коротку команду підключення.  
4) Ввімкніть **UFW** на сервері: дозволити тільки `22/tcp` з вашого IP; перевірте підключення.  
5) (Опціонально) Спробуйте `rsync` для синхронізації каталогу.

---

## 9) Безпека: кращі практики та типові помилки

- **Вимкніть парольний вхід** після налаштування ключів:
  ```bash
  sudo vim /etc/ssh/sshd_config
  PasswordAuthentication no
  ChallengeResponseAuthentication no
  UsePAM yes
  # (бажано) PermitRootLogin prohibit-password або no, і використовувати окремого користувача + sudo
  sudo systemctl reload sshd
  ```
- **Права на ключі та `.ssh`**:
  ```bash
  chmod 700 ~/.ssh
  chmod 600 ~/.ssh/id_ed25519 ~/.ssh/authorized_keys
  ```
- **`ssh-agent` і `ssh-add`** для зручної роботи з passphrase‑захищеними ключами.
- **Allowlist IP** у firewall і (за можливості) доступ через **VPN**/Bastion.
- **Підтвердження хоста**: при першому вході перевіряйте **fingerprint**; запис зберігається у `~/.ssh/known_hosts`.
- **Не заливайте приватні ключі в репозиторії** та не діліться ними.
- **Зміна порту** SSH не є захистом, але зменшує шум сканерів; використовуйте разом з ключами/Firewall/Fail2Ban.
- Типові помилки: «Permission denied (publickey)» (неправильні права або ключ не в `authorized_keys`), «Host key verification failed» (змінився fingerprint — перевірте, чому).

---

## 10) Контрольні питання

1. Чим відрізняються парольна автентифікація та автентифікація за ключами?
2. Де зберігати публічний ключ на сервері і які права мають бути на файли/папки?
3. Чому важливо відкривати **22/tcp** лише з дозволених IP?
4. Як підключитися ключем із нестандартною назвою/розташуванням?
5. Як одним рядком передати локальний скрипт і виконати його на сервері?
6. Чому варто вимкнути `PasswordAuthentication` у виробництві?

---

## 11) Аналогія: «хатина і приватний тунель»

- **SSH** — безпечний **тунель** між вашим домом (локальна машина) і **хатою** (сервер).
- **Логін+пароль** — звичайний ключ від дверей.
- **Пара ключів** — **особиста печатка** (приватний ключ) + **відбиток** на дверях (публічний).
- **Порт 22** — виділені двері в тунель.
- **Firewall** — охорона, що пускає лише дозволених і тільки у потрібні двері.
- **SCP** — захищений кур’єр, що переносить «посилки» (файли) тунелем.

---

## 12) Шпаргалка

```bash
# Генерація ключів
ssh-keygen -t ed25519 -C "you@example.com"

# Додати ключ на сервер
ssh-copy-id -i ~/.ssh/id_ed25519.pub user@host

# Підключення
ssh user@host
ssh -i ~/.ssh/custom_key user@host

# Конфіг (скорочення команд)
cat >> ~/.ssh/config <<'CFG'
Host prod
  HostName 203.0.113.10
  User ubuntu
  IdentityFile ~/.ssh/id_ed25519
CFG

# Копіювання файлів
scp -i ~/.ssh/id_ed25519 ./test.sh user@prod:/home/user/
rsync -avz -e "ssh -i ~/.ssh/id_ed25519" ./app/ user@prod:/opt/app/

# Права
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_ed25519 ~/.ssh/authorized_keys

# Перезапуск sshd після змін
sudo systemctl reload sshd
```

---

> **Висновок:** SSH — ваш головний інструмент керування Linux‑серверами: безпечний доступ, передача файлів і автоматизація. Налаштуйте ключі, обмежте доступ firewall‑ом і дотримуйтесь кращих практик — і віддалена робота стане швидкою й безпечною.
